<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestion des Concessions - Admin | Système Aquaculture</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --danger-color: #ef4444;
        }

        body {
            background-color: #f8fafc;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .navbar {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 76px);
        }

        .sidebar {
            width: 400px;
            background: white;
            border-right: 1px solid #e5e7eb;
            overflow-y: auto;
            box-shadow: 2px 0 4px rgba(0,0,0,0.05);
        }

        .map-container {
            flex: 1;
            position: relative;
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .form-section {
            padding: 1.5rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .form-section:last-child {
            border-bottom: none;
        }

        .form-section h6 {
            color: var(--primary-color);
            font-weight: 600;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
        }

        .form-section h6 i {
            margin-right: 0.5rem;
        }

        .coordinate-input {
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
        }

        .coordinate-help {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .drawing-instructions {
            background: #f0f9ff;
            border: 1px solid #0ea5e9;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .drawing-instructions h6 {
            color: #0369a1;
            margin-bottom: 0.5rem;
        }

        .drawing-instructions ol {
            margin: 0;
            padding-left: 1.2rem;
        }

        .drawing-instructions li {
            margin-bottom: 0.25rem;
            font-size: 0.9rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            border: none;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6b4c93 100%);
        }

        .concession-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .concession-item {
            padding: 0.75rem;
            border: 1px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .concession-item:hover {
            background-color: #f9fafb;
            border-color: var(--primary-color);
        }

        .concession-item.selected {
            background-color: #eff6ff;
            border-color: var(--primary-color);
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
        }

        .status-disponible { background-color: #dcfce7; color: #166534; }
        .status-reservee { background-color: #fef3c7; color: #92400e; }
        .status-occupee { background-color: #fee2e2; color: #991b1b; }
        .status-suspendue { background-color: #f3f4f6; color: #374151; }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .alert {
            border-radius: 0.5rem;
            border: none;
        }

        @media (max-width: 768px) {
            .main-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: 50vh;
            }
            
            .map-container {
                height: 50vh;
            }
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">
                <i class="fas fa-fish me-2"></i>
                Admin - Gestion des Concessions
            </a>
            <div class="navbar-nav ms-auto">
                <a class="nav-link" href="../index.html">
                    <i class="fas fa-arrow-left me-1"></i>Retour au site
                </a>
            </div>
        </div>
    </nav>

    <!-- Alert Container -->
    <div id="alert-container" class="container-fluid mt-2"></div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Instructions -->
            <div class="form-section">
                <div class="drawing-instructions">
                    <h6><i class="fas fa-info-circle"></i>Instructions</h6>
                    <ol>
                        <li>Utilisez l'outil polygone pour dessiner la zone sur la carte</li>
                        <li>Cliquez sur 4 points pour former un quadrilatère</li>
                        <li>Les coordonnées se rempliront automatiquement</li>
                        <li>Complétez les informations et sauvegardez</li>
                    </ol>
                </div>
            </div>

            <!-- Formulaire de création -->
            <div class="form-section">
                <h6><i class="fas fa-plus-circle"></i>Nouvelle Concession</h6>
                
                <form id="concession-form">
                    <!-- Localisation -->
                    <div class="mb-3">
                        <label class="form-label">Wilaya <span class="text-danger">*</span></label>
                        <select class="form-select" name="wilaya" required>
                            <option value="">Sélectionner une wilaya</option>
                            <option value="Adrar">01 - Adrar</option>
                            <option value="Chlef">02 - Chlef</option>
                            <option value="Laghouat">03 - Laghouat</option>
                            <option value="Oum El Bouaghi">04 - Oum El Bouaghi</option>
                            <option value="Batna">05 - Batna</option>
                            <option value="Béjaïa">06 - Béjaïa</option>
                            <option value="Biskra">07 - Biskra</option>
                            <option value="Béchar">08 - Béchar</option>
                            <option value="Blida">09 - Blida</option>
                            <option value="Bouira">10 - Bouira</option>
                            <option value="Tamanrasset">11 - Tamanrasset</option>
                            <option value="Tébessa">12 - Tébessa</option>
                            <option value="Tlemcen">13 - Tlemcen</option>
                            <option value="Tiaret">14 - Tiaret</option>
                            <option value="Tizi Ouzou">15 - Tizi Ouzou</option>
                            <option value="Alger">16 - Alger</option>
                            <option value="Djelfa">17 - Djelfa</option>
                            <option value="Jijel">18 - Jijel</option>
                            <option value="Sétif">19 - Sétif</option>
                            <option value="Saïda">20 - Saïda</option>
                            <option value="Skikda">21 - Skikda</option>
                            <option value="Sidi Bel Abbès">22 - Sidi Bel Abbès</option>
                            <option value="Annaba">23 - Annaba</option>
                            <option value="Guelma">24 - Guelma</option>
                            <option value="Constantine">25 - Constantine</option>
                            <option value="Médéa">26 - Médéa</option>
                            <option value="Mostaganem">27 - Mostaganem</option>
                            <option value="M'Sila">28 - M'Sila</option>
                            <option value="Mascara">29 - Mascara</option>
                            <option value="Ouargla">30 - Ouargla</option>
                            <option value="Oran">31 - Oran</option>
                            <option value="El Bayadh">32 - El Bayadh</option>
                            <option value="Illizi">33 - Illizi</option>
                            <option value="Bordj Bou Arréridj">34 - Bordj Bou Arréridj</option>
                            <option value="Boumerdès">35 - Boumerdès</option>
                            <option value="El Tarf">36 - El Tarf</option>
                            <option value="Tindouf">37 - Tindouf</option>
                            <option value="Tissemsilt">38 - Tissemsilt</option>
                            <option value="El Oued">39 - El Oued</option>
                            <option value="Khenchela">40 - Khenchela</option>
                            <option value="Souk Ahras">41 - Souk Ahras</option>
                            <option value="Tipaza">42 - Tipaza</option>
                            <option value="Mila">43 - Mila</option>
                            <option value="Aïn Defla">44 - Aïn Defla</option>
                            <option value="Naâma">45 - Naâma</option>
                            <option value="Aïn Témouchent">46 - Aïn Témouchent</option>
                            <option value="Ghardaïa">47 - Ghardaïa</option>
                            <option value="Relizane">48 - Relizane</option>
                        </select>
                    </div>

                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">Daïra <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="daira" required>
                        </div>
                        <div class="col-6">
                            <label class="form-label">Commune <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" name="commune" required>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">ZAA/Lieu-dit</label>
                        <input type="text" class="form-control" name="lieu_dit" placeholder="Zone d'activité aquacole ou lieu-dit">
                    </div>

                    <!-- Superficies -->
                    <div class="row mb-3">
                        <div class="col-6">
                            <label class="form-label">À terre (ha)</label>
                            <input type="number" class="form-control" name="superficie_terre" step="0.01" min="0">
                        </div>
                        <div class="col-6">
                            <label class="form-label">En mer/plan d'eau (ha)</label>
                            <input type="number" class="form-control" name="superficie_mer" step="0.01" min="0">
                        </div>
                    </div>

                    <!-- Coordonnées -->
                    <div class="mb-3">
                        <label class="form-label">Coordonnées géographiques <span class="text-danger">*</span></label>
                        <div class="row g-2">
                            <div class="col-6">
                                <label class="form-label small">Point A</label>
                                <input type="text" class="form-control coordinate-input" name="coordonnee_a" 
                                       placeholder="36.7538,3.0588" readonly>
                                <div class="coordinate-help">Latitude, Longitude</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Point B</label>
                                <input type="text" class="form-control coordinate-input" name="coordonnee_b" 
                                       placeholder="36.7548,3.0598" readonly>
                                <div class="coordinate-help">Latitude, Longitude</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Point C</label>
                                <input type="text" class="form-control coordinate-input" name="coordonnee_c" 
                                       placeholder="36.7528,3.0608" readonly>
                                <div class="coordinate-help">Latitude, Longitude</div>
                            </div>
                            <div class="col-6">
                                <label class="form-label small">Point D</label>
                                <input type="text" class="form-control coordinate-input" name="coordonnee_d" 
                                       placeholder="36.7518,3.0578" readonly>
                                <div class="coordinate-help">Latitude, Longitude</div>
                            </div>
                        </div>
                    </div>

                    <!-- Description -->
                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control" name="description" rows="3" 
                                  placeholder="Description de la zone, conditions particulières..."></textarea>
                    </div>

                    <!-- Boutons -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save me-2"></i>Créer la concession
                        </button>
                        <button type="button" class="btn btn-outline-secondary" onclick="clearForm()">
                            <i class="fas fa-times me-2"></i>Annuler
                        </button>
                    </div>
                </form>
            </div>

            <!-- Liste des concessions -->
            <div class="form-section">
                <h6><i class="fas fa-list"></i>Concessions existantes</h6>
                <div id="concessions-list" class="concession-list">
                    <!-- Les concessions seront chargées ici -->
                </div>
            </div>
        </div>

        <!-- Carte -->
        <div class="map-container">
            <div id="loading-overlay" class="loading-overlay d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Chargement...</span>
                </div>
            </div>
            <div id="map"></div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    
    <script>
        // Configuration
        const API_BASE_URL = '../../backend/api';
        
        // Variables globales
        let map;
        let drawControl;
        let drawnItems;
        let currentPolygon = null;
        let concessions = [];
        let selectedConcession = null;

        // Initialisation
        $(document).ready(function() {
            initMap();
            loadConcessions();
            
            // Gestionnaire de formulaire
            $('#concession-form').on('submit', handleFormSubmit);
        });

        // Initialiser la carte
        function initMap() {
            // Créer la carte centrée sur l'Algérie
            map = L.map('map').setView([28.0339, 1.6596], 6);

            // Ajouter les tuiles
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);

            // Groupe pour les éléments dessinés
            drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);

            // Contrôles de dessin
            drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polygon: {
                        allowIntersection: false,
                        drawError: {
                            color: '#e1e100',
                            message: '<strong>Erreur!</strong> Les lignes ne peuvent pas se croiser!'
                        },
                        shapeOptions: {
                            color: '#667eea',
                            weight: 3,
                            fillOpacity: 0.2
                        }
                    },
                    polyline: false,
                    rectangle: false,
                    circle: false,
                    marker: false,
                    circlemarker: false
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            map.addControl(drawControl);

            // Événements de dessin
            map.on('draw:created', function(e) {
                const layer = e.layer;
                
                if (e.layerType === 'polygon') {
                    // Supprimer le polygone précédent
                    if (currentPolygon) {
                        drawnItems.removeLayer(currentPolygon);
                    }
                    
                    currentPolygon = layer;
                    drawnItems.addLayer(layer);
                    
                    // Extraire les coordonnées
                    const coordinates = layer.getLatLngs()[0];
                    if (coordinates.length >= 4) {
                        updateCoordinateInputs(coordinates.slice(0, 4));
                    }
                }
            });

            map.on('draw:edited', function(e) {
                if (currentPolygon) {
                    const coordinates = currentPolygon.getLatLngs()[0];
                    if (coordinates.length >= 4) {
                        updateCoordinateInputs(coordinates.slice(0, 4));
                    }
                }
            });

            map.on('draw:deleted', function(e) {
                currentPolygon = null;
                clearCoordinateInputs();
            });
        }

        // Mettre à jour les champs de coordonnées
        function updateCoordinateInputs(coordinates) {
            const fields = ['coordonnee_a', 'coordonnee_b', 'coordonnee_c', 'coordonnee_d'];
            
            coordinates.forEach((coord, index) => {
                if (index < 4) {
                    const lat = coord.lat.toFixed(6);
                    const lng = coord.lng.toFixed(6);
                    $(`input[name="${fields[index]}"]`).val(`${lat},${lng}`);
                }
            });
        }

        // Vider les champs de coordonnées
        function clearCoordinateInputs() {
            ['coordonnee_a', 'coordonnee_b', 'coordonnee_c', 'coordonnee_d'].forEach(field => {
                $(`input[name="${field}"]`).val('');
            });
        }

        // Charger les concessions existantes
        async function loadConcessions() {
            try {
                showLoading();
                
                const response = await fetch(`${API_BASE_URL}/concessions.php`);
                const data = await response.json();
                
                if (data.success) {
                    concessions = data.data;
                    displayConcessionsList();
                    displayConcessionsOnMap();
                } else {
                    showAlert('danger', 'Erreur lors du chargement des concessions');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('danger', 'Erreur de connexion au serveur');
            } finally {
                hideLoading();
            }
        }

        // Afficher la liste des concessions
        function displayConcessionsList() {
            const container = $('#concessions-list');
            
            if (concessions.length === 0) {
                container.html('<p class="text-muted">Aucune concession créée</p>');
                return;
            }
            
            let html = '';
            concessions.forEach(concession => {
                const statusClass = `status-${concession.statut}`;
                html += `
                    <div class="concession-item" data-id="${concession.id_concession}" onclick="selectConcession(${concession.id_concession})">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <strong>${concession.wilaya} - ${concession.commune}</strong>
                            <span class="status-badge ${statusClass}">${concession.statut}</span>
                        </div>
                        <div class="small text-muted">
                            ${concession.lieu_dit || 'Lieu non spécifié'}
                        </div>
                        <div class="small text-muted mt-1">
                            Terre: ${concession.superficie_terre || 0} ha | 
                            Mer: ${concession.superficie_mer || 0} ha
                        </div>
                    </div>
                `;
            });
            
            container.html(html);
        }

        // Afficher les concessions sur la carte
        function displayConcessionsOnMap() {
            // Supprimer les marqueurs existants
            map.eachLayer(layer => {
                if (layer.options && layer.options.concessionId) {
                    map.removeLayer(layer);
                }
            });
            
            concessions.forEach(concession => {
                if (concession.coordonnee_a && concession.coordonnee_b && 
                    concession.coordonnee_c && concession.coordonnee_d) {
                    
                    const coordinates = [
                        parseCoordinate(concession.coordonnee_a),
                        parseCoordinate(concession.coordonnee_b),
                        parseCoordinate(concession.coordonnee_c),
                        parseCoordinate(concession.coordonnee_d)
                    ];
                    
                    const color = concession.statut === 'disponible' ? '#10b981' : 
                                 concession.statut === 'reservee' ? '#f59e0b' : '#ef4444';
                    
                    const polygon = L.polygon(coordinates, {
                        color: color,
                        weight: 2,
                        fillOpacity: 0.3,
                        concessionId: concession.id_concession
                    }).addTo(map);
                    
                    polygon.bindPopup(`
                        <div>
                            <strong>${concession.wilaya} - ${concession.commune}</strong><br>
                            ${concession.lieu_dit || ''}<br>
                            <small>Statut: ${concession.statut}</small><br>
                            <small>Terre: ${concession.superficie_terre || 0} ha</small><br>
                            <small>Mer: ${concession.superficie_mer || 0} ha</small>
                        </div>
                    `);
                }
            });
        }

        // Sélectionner une concession
        function selectConcession(id) {
            // Mettre à jour l'interface
            $('.concession-item').removeClass('selected');
            $(`.concession-item[data-id="${id}"]`).addClass('selected');
            
            selectedConcession = concessions.find(c => c.id_concession == id);
            
            // Centrer la carte sur la concession
            if (selectedConcession) {
                const coordinates = [
                    parseCoordinate(selectedConcession.coordonnee_a),
                    parseCoordinate(selectedConcession.coordonnee_b),
                    parseCoordinate(selectedConcession.coordonnee_c),
                    parseCoordinate(selectedConcession.coordonnee_d)
                ];
                
                const bounds = L.latLngBounds(coordinates);
                map.fitBounds(bounds, { padding: [20, 20] });
            }
        }

        // Gestionnaire de soumission du formulaire
        async function handleFormSubmit(e) {
            e.preventDefault();
            
            try {
                const formData = new FormData(e.target);
                const data = Object.fromEntries(formData.entries());
                
                // Validation
                if (!data.coordonnee_a || !data.coordonnee_b || !data.coordonnee_c || !data.coordonnee_d) {
                    showAlert('warning', 'Veuillez dessiner la zone sur la carte');
                    return;
                }
                
                showLoading();
                
                const response = await fetch(`${API_BASE_URL}/concessions.php`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showAlert('success', 'Concession créée avec succès!');
                    clearForm();
                    loadConcessions();
                } else {
                    showAlert('danger', result.error || 'Erreur lors de la création');
                }
                
            } catch (error) {
                console.error('Erreur:', error);
                showAlert('danger', 'Erreur de connexion au serveur');
            } finally {
                hideLoading();
            }
        }

        // Vider le formulaire
        function clearForm() {
            $('#concession-form')[0].reset();
            clearCoordinateInputs();
            
            if (currentPolygon) {
                drawnItems.removeLayer(currentPolygon);
                currentPolygon = null;
            }
        }

        // Fonctions utilitaires
        function parseCoordinate(coordString) {
            const [lat, lng] = coordString.split(',').map(parseFloat);
            return [lat, lng];
        }

        function showLoading() {
            $('#loading-overlay').removeClass('d-none');
        }

        function hideLoading() {
            $('#loading-overlay').addClass('d-none');
        }

        function showAlert(type, message) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                    <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : 'info-circle'} me-2"></i>
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('#alert-container').html(alertHtml);
            
            setTimeout(() => {
                $('.alert').fadeOut();
            }, 5000);
        }
    </script>
</body>
</html>
